/*! PURPLE.js (DEBUG) v0.7.2-alpha 2015-11-12 14:33:09 UTC
 * YOU CANNOT USE THIS FILE ON ANY OTHER PLATFORM.*/
!function(a){function b(){function b(a,b,c){return"undefined"!=typeof this.disabled?c():(this.disabled=!0,m.conf.spa?(console.info("监听anchor点击: 开启"),document.addEventListener("click",function(a){function b(a){a!=document.body&&null!=a&&("A"==a.nodeName?"undefined"!=typeof a.attributes.href&&c(a.attributes.href.value):b(a.parentNode))}function c(b){"#"!=b.substr(0,1)&&(d(location.href).href==d(b).href?"file:"==m.conf.protocol?e(b):(a.preventDefault(),console.info("相同url默认无操作,如有特殊需求请手动app.go()")):d(location.href).beforeHash()==d(b).beforeHash()?""==d(b).hash?e(b):console.log("#2",location.href,b):d(location.href).origin()==d(b).origin()?e(b):console.log("#3",location.href,b))}function e(b){a.preventDefault(),console.info("开始解析:"+b),m.app.go(b,"push")}b(a.target)},!1),void c()):c())}function c(a,b,c){return"undefined"!=typeof this.disabled?c():(this.disabled=!0,m.conf.spa?(console.info("监听浏览器popstate状态: 开启"),window.addEventListener("popstate",function(a){d(m.state.curUrl).beforeHash()!=d(location.href).beforeHash()&&m.app.go(location.href,"replace")},!1),void c()):c())}function d(a){function b(){return g.href.replace(/#.*/,"")}function c(){var a=g.pathname||"/"+g.pathname;return a.replace(/^([^\/])/,"/$1")}function d(){return h(g.pathname.replace(/^\//,"").split("/"),"")}function e(){for(var a={},b=g.search.replace(/^\?/,"").split("&"),c=b.length,d=0;c>d;d++)if(b[d]){var e=b[d].split("=");a[e[0]]=e[1]}return a}function f(){if("undefined"!=typeof g.origin)return g.origin;var a=g.protocol+"//"+g.hostname;return""==g.port?a:"80"==g.port&&"http:"==g.protocol?a:"443"==g.port&&"https"==g.protocol?a:a+=":"+g.port}var g=document.createElement("a");return g.href=a,{href:g.href,hash:g.hash,port:g.port,protocol:g.protocol,pathname:c,params:d,query:e,origin:f,beforeHash:b,all:function(){return{port:g.port,protocol:g.protocol,hostname:g.hostname,pathname:c(),params:d(),query:e(),origin:f()}}}}function e(a,b){var c=a.length;if("function"!=typeof b)throw new TypeError;for(var d=0;c>d;d++)d in a&&b.call(arguments[1],a[d],d,a)}function f(a,b){var c={};for(var d in a)Object.prototype.hasOwnProperty.call(a,d)&&"function"==typeof b&&(c[d]=b.call(a,a[d],d,a));return c}function g(){var a={},b=Array.prototype.slice.call(arguments,0);return e(b,function(b,c){for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d])}),a}function h(a,b){var c=[];return e(a,function(a){a!==b&&c.push(a)}),c}function i(){var a=[];return{__stack:a,use:function(b){a.push(b)},route:function(b){return{get:function(){var c=Array.prototype.slice.call(arguments,0);f(c,function(c,d){a.push([b,c])})}}}}}function j(){var a={};return function(b,c){var d="undefined"!=typeof a[b];return"function"==typeof c?(d&&console.warn("controller has exits, but this new controller will be registered: "+b),a[b]=c):d||(console.warn("controller lost fn param, but it still run: "+b),a[b]=function(a,b,c){c()}),a[b]}}function k(a){try{return 4==a.toString().match(/[A-Z0-9a-z,(\s]*\)/)[0].split(",").length}catch(b){return!1}}function l(a,b){try{return a.filterPath.match(b)[0]==a.filterPath}catch(c){return!1}}!function(a,b){function c(a,b){a=a.push?a:[a];var c,d,e,f,g=[],h=a.length,i=h;for(c=function(a,c){c.length&&g.push(a),i-=1,0===i&&b(g)};h--;)d=a[h],e=k[d],e?c(d,e):(f=l[d]=l[d]||[],f.push(c))}function d(a,b){if(a){var c=l[a];if(k[a]=b,c)for(;c.length;)c[0](a,b),c.splice(0,1)}}function e(a,c){var d=b.createElement("script");d.style="text/javascript",d.async=!0,d.src=a,d.onload=d.onerror=function(b){d.parentNode.removeChild(d),d=null,c(a,b.type)},h.appendChild(d)}function f(a,b){a=a.push?a:[a];var c,d=a.length,f=d,g=[];for(c=function(a,c){"error"===c&&g.push(a),f-=1,0===f&&b(g)};d--;)e(a[d],c)}function g(b,c,e,g){var h,k,l;if(c&&!c.call&&(h=c),k=h?e:c,l=h?g:e,h){if(h in j)throw new Error("LoadJS: Bundle already defined");j[h]=!0}a.setTimeout(function(){f(b,function(a){a.length?(l||i)(a):(k||i)(),d(h,a)})},0)}var h=b.head,i=function(){},j={},k={},l={};g.ready=function(a,b,d){return c(a,function(a){a.length?(d||i)(a):(b||i)()}),g},g.done=function(a){d(a,[])},a.loadjs=g}(a,document);var m={init:!1},n=function(){return m.init?m.app:(m.conf={timeout:6e4,routeByQuery:!1,routeQuery:"route",routeScope:"",spa:!1,protocol:null},m.state={complete:!0,prevUrl:null,curUrl:location.href,errorStack:null},m.stack=[],m.app={},m.app.config=function(a,b){return"undefined"!=typeof b&&(m.conf[a]=b),m.conf[a].toString()||void 0},m.app.use=function(){if(1==arguments.length)if("function"==typeof arguments[0]){var a={fn:arguments[0]};a.isErrorHandle=k(a.fn),m.stack.push(a)}else if(arguments[0]instanceof Array){var b=arguments[0];f(b,function(a,b){"function"==typeof a?m.app.use(a):a instanceof Array&&2==a.length?m.app.use(a[0],a[1]):(console.warn("use参数有误"),console.warn(a))})}else arguments[0]instanceof Object?arguments[0].__stack instanceof Array?m.app.use(arguments[0].__stack):console.warn("use router 时参数有误"):console.warn("use参数异常");else if(2==arguments.length){var c=arguments[0];c instanceof Array?c=new RegExp("(^"+c.join("$)|(^")+"$)"):"string"==typeof c&&(c=new RegExp("^"+c+"$")),!c instanceof RegExp&&console.error("route参数错误: "+c),m.stack.push({fn:arguments[1],path:c,isErrorHandel:k(arguments[1])})}},m.app.route=function(a){return{get:function(){var b=Array.prototype.slice.call(arguments,0);f(b,function(b,c){m.app.use(a,b)})}}},m.app.go=function(a,b){if(!m.state.complete)return!1;m.state.complete=!1;var c=d(a||location.href).all();if(m.conf.routeByQuery){console.log(c.query);var e=c.query[m.conf.routeQuery]||"/"}else{if(c.pathname.match(new RegExp("^"+m.conf.routeScope)))var e=c.pathname.substr(m.conf.routeScope.length)||"/";else var e="/";c.params=h(e.replace(/^\//,"").split("/"),"")}console.info("请求地址: "+e);var f=setTimeout(function(){k.end(),console.warn("超时")},m.conf.timeout),i=g(c,{routed:!1,expire:Date.now()+m.conf.timeout,conf:m.conf,state:m.state,filterPath:e,rawUrl:a,historyStateType:b||"push"}),j=!1,k={end:function(){j=!0,m.state.complete=!0,m.state.errorStack=null,clearTimeout(f),console.info("请求结束"),m.conf.spa&&"file:"!=m.conf.protocol&&(console.log("spa: "+m.conf.spa),"replace"==i.historyStateType?history.replaceState("data","title",i.rawUrl):history.pushState("data","title",i.rawUrl))},redirect:function(a){k.end(),console.log("请求跳转"),m.conf.spa?m.app.go(a,"push"):location.replace(a)}},n=-1,o=function(a){function b(){m.stack[n].isErrorHandle?m.stack[n].fn(m.state.errorStack,i,k,o):m.stack[n].fn(i,k,o)}return j?console.error("Run next() after red.end(), PLS check."):(n++,"undefined"!=typeof a&&(m.state.errorStack||(m.state.errorStack=[]),m.state.errorStack.push(a)),void(n>=m.stack.length?(m.state.errorStack&&console.error(m.state.errorStack),i.routed||console.error("404 not found"),k.end()):"undefined"!=typeof m.stack[n].disabled?o():"undefined"!=typeof m.stack[n].path?l(i,m.stack[n].path)?(i.routed=!0,b()):o():b()))};o()},m.app.config("protocol",location.protocol),m.app.use(c),m.app.use(b),m.init=!0,m.app)};return n.Controller=j,n.Router=i,a.require=function(){var a=Array.prototype.slice.call(arguments,0);return function(b,c,d){loadjs(a,function(){d()},function(a){d(a)})}},n}"function"==typeof define&&define.amd?define(function(){return b()}):a.pansy=b()}(this);