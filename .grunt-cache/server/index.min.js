function md5(a){return crypto.createHash("md5").update(a).digest("hex")}var path=require("path"),crypto=require("crypto"),fs=require("fs"),tls=require("tls"),net=require("net"),cookieParser=require("cookie-parser"),bodyParser=require("body-parser"),httpProxy=require("http-proxy"),request=require("request"),express=require("express"),parse=require("url-parse"),morgan=require("morgan"),ent=require("ent"),pem=require("pem"),_=require("lodash"),Datastore=require("nedb"),app=require("express")(),router=require("express").Router(),http=require("http").Server(app),conf={morgan:{format:":method :status :req[host] :url",options:{}},isChecked:!1,isInstalled:!1},db={};db.cname=new Datastore({filename:path.join(__dirname,"./data/cname.db"),autoload:!0}),db.host=new Datastore({filename:path.join(__dirname,"./data/host.db"),autoload:!0}),db.config=new Datastore({filename:path.join(__dirname,"./data/config.db"),autoload:!0});var checkInstall=function(a,b,c){return conf.isChecked?c():void db.config.findOne({},function(a,d){return conf.isChecked=!0,a?b.sendStatus(500):(d&&(conf.isInstalled=!0,conf=_.extend(conf,d)),void c())})},cnameApp={};cnameApp.requireInstall=function(a,b,c){return conf.isInstalled?void c():b.json({error:"UNINSTALLED"})},cnameApp.requireEqualHost=function(a,b,c){return conf.isInstalled?a.hostname!==conf.hostname?b.json({error:"UNEQUAL_HOSTNAME"}):void c():c()},cnameApp.requireAdmin=function(a,b,c){return _.has(a.locals,"admin")?void c():b.json({error:"PERMISSION_DENIED"})},cnameApp.status=function(a,b,c){b.json(conf)},cnameApp.install=function(a,b,c){return conf.isInstalled?b.sendStatus(403):void b.sendStatus(500)},cnameApp.login=function(a,b,c){b.json({})},cnameApp.renderApp=function(a,b,c){b.end("cname app")};var errHandle={};errHandle.status500=function(a,b){b.sendStatus(404)},errHandle.status404=function(a,b){b.sendStatus(404)};var hostParser=function(a,b,c){return conf.isInstalled?a.hostname==conf.hostname?c():void db.host.findOne({hostname:a.hostname},function(c,d){if(c)return b.sendStatus(500);if(!d)return b.sendStatus(404);a.locals.host=d;var e=d.hostId;db.cname.findOne({hostId:e,type:"block"},function(c,d){return c?b.sendStatus(500):d?b.redirect("http://www.google.com"):void db.cname.findOne({hostId:e,pathname:a.pathname},function(c,d){if(c)return b.sendStatus(500);if(!d)return b.sendStatus(404);if("proxy"==d.type){var e={},f=conf.proxy[a.headers.host];httpProxy.createProxyServer(e).web(a,b,{target:f},function(a){a&&(console.log(a),b.sendStatus(502)),b.end()})}else(d.type="html")?b.end(d.content):b.sendStatus(404)})})}):c()};router.route(["/","/install","/host"]).get(cnameApp.requireEqualHost,cnameApp.renderApp),router.route("/api/status").get(cnameApp.requireEqualHost,cnameApp.status),router.route("/api/install").post(cnameApp.install),router.route("/api/cnames").post(cnameApp.requireInstall,cnameApp.requireEqualHost,cnameApp.requireAdmin),router.route("/api/cname/create").post(cnameApp.requireInstall,cnameApp.requireEqualHost,cnameApp.requireAdmin),app.set("x-powered-by",!1),app.use(morgan(conf.morgan.format,conf.morgan.options)),app.use(checkInstall),app.use(hostParser),app.use(bodyParser.json()),app.use(bodyParser.json({type:"application/*+json"})),app.use(bodyParser.json({type:"text/html"})),app.use(bodyParser.urlencoded({extended:!1})),app.use(router),app.use(errHandle.status500),app.use(errHandle.status404),db.config.findOne({},function(a,b){return a?console.log(a):(b&&(conf=b,conf.isInstalled=!0),void http.listen(80,function(){console.log("Listening on port 80")}))});