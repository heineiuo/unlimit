/*! webapp v0.0.1-pre 2015-11-14 13:31:12 */
var path=require("path"),crypto=require("crypto"),http=require("http"),https=require("https"),fs=require("fs"),tls=require("tls"),net=require("net"),cookieParser=require("cookie-parser"),bodyParser=require("body-parser"),httpProxy=require("http-proxy"),request=require("request"),express=require("express"),parse=require("url-parse"),morgan=require("morgan"),ent=require("ent"),pem=require("pem"),_=require("lodash"),purple={};purple.Controller=function(){var a={};return function(b,c){var d="undefined"!=typeof a[b];return"function"==typeof c?(d&&console.warn("controller has exits, but this new controller will be registered: "+b),a[b]=c):d||(console.warn("controller lost fn param, but it still run: "+b),a[b]=function(a,b,c){c()}),a[b]}};var controller=controller||purple.Controller();controller("block.check",function(a,b,c){_.indexOf(conf.block_host,a.headers.host)>=0?b.redirect("http://www.google.com"):c()});var controller=controller||purple.Controller();controller("error.err500",function(a,b,c,d){return a?(console.log({error:"EXCEPTION_ERROR",stack:a.stack}),void c.send(500)):d()}),controller("error.err404",function(a,b){b.send(403)});var controller=controller||purple.Controller();controller("proxy.check",function(a,b,c){if(_.has(conf.proxy,a.headers.host)){var d={},e=conf.proxy[a.headers.host];httpProxy.createProxyServer(d).web(a,b,{target:e},function(a){a&&(console.log(a),b.status(502)),b.end()})}else c()});var controller=controller||purple.Controller();controller("render.renderApp",function(a,b,c){var d=parse(a.headers.host+a.url,!0);""==d.pathname&&(d.pathname="/");var e={};if(_.map(conf.cname.list,function(a,b){if(a.hostname!=d.host)return!0;var c=new RegExp(_.trim(a.pathname,"/").replace("\\\\","\\")),f=d.pathname.match(c);return f&&f[0]==d.pathname?(e=a,!1):void 0}),!_.has(e,"type"))return c();if("redirect"==e.type)return b.redirect(e.content);if("html"==e.type)return b.send(ent.decode(e.content));if("api"==e.type){var f={method:"POST",url:conf.API_HOST+e.content,qs:a.query,form:_.extend(a.body,a.query,{appId:conf.appId,appSecret:conf.appSecret,proxyAppId:e.appId})};request(f,function(a,c,d){if(a)return b.send(500);try{b.json(JSON.parse(d))}catch(e){console.log(d),b.send(502)}})}else c()});var controller=controller||purple.Controller();controller("update.check",function(a,b,c){if(c(),conf.cnameUpdating)return!1;if(Date.now()<conf.cnameExpire)return!1;conf.cnameUpdating=!0;var d={method:"POST",url:conf.API_HOST+"/service/cname",form:{appId:conf.appId,appSecret:conf.appSecret}};console.log("正在更新...."),request(d,function(a,b){if(a)return conf.cnameUpdating=!1,!1;try{var c=JSON.parse(b.body);if(c.error)return console.log("更新失败：服务器返回错误: "+c.error);c.update_time=new Date,conf.cname=c,conf.cnameExpire=Date.now()+conf.timeout,fs.writeFile(conf.appdata+"/cname.json",JSON.stringify(c),"utf-8",function(a){a&&(console.log(a),console.log("更新失败: 保存cname信息失败")),conf.cnameUpdating=!1,console.log("更新成功.")})}catch(d){console.log(d),console.log("更新失败: 异常"),conf.cnameUpdating=!1}})});var conf={appId:"621b898e-7f9e-4b44-8981-c971998a60ef",appSecret:"250af5fa7f6a86a245b161a83c1e0e17",appName:"cname-ecs6",API_HOST:"http://127.0.0.1:8888",proxy:{"api.heineiuo.com":"http://127.0.0.1:8888","api.youkuohao.com":"http://127.0.0.1:8888","static1.heineiuo.com":"http://127.0.0.1:8001"},block_host:[],ssl:{},isStarted:!1,morgan:{format:":method :status :req[host] :url",options:{}},cnameUpdating:!1,timeout:3e4,cnameExpire:Date.now(),cname:{list:[]},isInstalled:!1,appdata:path.join(__dirname,"./appdata"),md5:function(a){return crypto.createHash("md5").update(a).digest("hex")}};if(!conf.isStarted){var app=express();app.set("x-powered-by",!1),app.use(morgan(conf.morgan.format,conf.morgan.options)),app.use(controller("block.check")),app.use(controller("proxy.check")),app.use(controller("update.check")),app.use(bodyParser.json()),app.use(bodyParser.json({type:"application/*+json"})),app.use(bodyParser.json({type:"text/html"})),app.use(bodyParser.urlencoded({extended:!1})),app.use(controller("render.renderApp")),app.use(controller("error.err500")),app.use(controller("error.err404")),http.createServer(app).listen(80),console.log("Listening on port 80"),console.log("Listening on port 443")}module.exports=app;